<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pet shop - food</title>
<script src="//cdnjs.cloudflare.com/ajax/libs/json2/20110223/json2.js"></script>
<script src="js/jquery-2.1.4.min.js"></script>
<script src="js/jstorage.js"></script>
</head>
<body>
	<script type="application/javascript">
	function tableHeadHTML(){
		return '<tr><th>Food</th><th>Weight</th><th>Price</th><th>Avail.Qnt.</th><th>Wish</th></tr>'; 
	}
	function tableLineHTML(value){
		return '<tr id="' + value.id + '"><td id="name' + value.id + '">' + value.name + '</td><td id="weight' + value.id + '">' + value.weight + '</td><td id="price' + value.id + '">' + value.price + '</td><td id="quantity' + value.id + '">' + value.quantity +
	     	   '</td><td><input id="add_num_' + value.id + '" type="text" name="add_num_' + value.id + '"/>' +
    	       '<button class="btn_add" onclick="addGood(' + value.id + ')">Add to basket</button></td></tr>';
	}
	function addGood(id){		
		var name = $("#name"+id).text();
        var weight = $('#weight'+id).text();
        var price = $('#price'+id).text();
        var quantity = $('#quantity'+id).text();        
        var add = $('input[name="add_num_' + id + '"]').val();
		var description = "Name: " + name + ", Weight: " + weight + ", Price: " + price;
        if (add > quantity) {
        	alert("Too much!");
        } else {
			$('input[name="add_num_' + id + '"]').val("");
			if (add == 0){
				$.jStorage.deleteKey(id);
				if(sessionStorage.pnum > 0)
					sessionStorage.pnum = Number(sessionStorage.pnum) - 1;
			} else {
        		var purchase = {
        			id : id,
            		description : description,
            		quantity: add
        		};
        		if( $.jStorage.get(id) == null)
        			if (sessionStorage.pnum) {
			    		sessionStorage.pnum = Number(sessionStorage.pnum) + 1;
					} else {					
			    		sessionStorage.pnum = 1;
					}        		
        		$.jStorage.set(id,purchase);
			}
			$("#pnum").text(sessionStorage.pnum);
        }
	}	
    $.getJSON("api/foods", function (data) {
        console.log("get - " + data);
        var trHTML = '';
        $.each(data, function (index, value) {
            trHTML += tableLineHTML(value);
        });

        $('#foods_table').append(trHTML);
    });
    $(document).ready(function () {
    	if (!sessionStorage.pnum) sessionStorage.pnum = $.jStorage.index().length;
    	$("#pnum").text(sessionStorage.pnum);
        $("#btn_cancel").click(function () {
    		$("#btn_create").show();
    		$("#btn_update").hide();
    		$("#btn_cancel").hide();
            $('#input_name').val('');
            $('#input_weight').val('');
            $('#input_price').val('');
            $('#input_quantity').val('');
            $(".btn_x").removeAttr("disabled");
            update_id = 0;
        });
        $("#btn_filter_by_name").click(function () {
            var name = $('input[name="filter_name"]').val();
            console.log("filter - " + name);
            $.getJSON("api/foods/"+name, function(result) {
		            var trHTML = tableHeadHTML();
		            $.each(result, function (ind, value) {
		                trHTML += tableLineHTML(value);
		            });

		            $('#foods_table').html(trHTML);
		    	}
			);
    		$("#btn_discard_filter_by_name").show();
        });
        $("#btn_filter_by_weight").click(function () {
            var start = $('input[name="filter_start"]').val();
            var end = $('input[name="filter_end"]').val();
            console.log("filter by weight - " + name);
            $.getJSON("api/foods/"+start+"/"+end, function(result) {
		            var trHTML = tableHeadHTML();
		            $.each(result, function (ind, value) {
		                trHTML += tableLineHTML(value);
		            });

		            $('#foods_table').html(trHTML);
		    	}
			);
    		$("#btn_discard_filter_by_weight").show();
        });
        $("#btn_discard_filter_by_name").click(function () {
            console.log("discard filter by name");
            $.getJSON("api/foods", function(result) {
		            var trHTML = tableHeadHTML();
		            $.each(result, function (ind, value) {
		                trHTML += tableLineHTML(value);
		            });

		            $('#foods_table').html(trHTML);
		    	}
			);
            $('#filter_name').val('');
    		$("#btn_discard_filter_by_name").hide();
        });
        $("#btn_discard_filter_by_weight").click(function () {
            console.log("discard filter by weight");
            $.getJSON("api/foods", function(result) {
		            var trHTML = tableHeadHTML();
		            $.each(result, function (ind, value) {
		                trHTML += tableLineHTML(value);
		            });

		            $('#foods_table').html(trHTML);
		    	}
			);
            $('#filter_start').val('');
            $('#filter_end').val('');
    		$("#btn_discard_filter_by_weight").hide();
        });       
        
    });	
	</script>

	<p>
		Filter by Name: <input id="filter_name" type="text" name="filter_name" />
		<button id="btn_filter_by_name">Filter</button>
		<button id="btn_discard_filter_by_name" hidden="hidden">Discard</button>
	</p>
	<p>
		Filter by Weight Range: <input id="filter_start" type="text"
			name="filter_start" /> <input id="filter_end" type="text"
			name="filter_end" />
		<button id="btn_filter_by_weight">Filter</button>
		<button id="btn_discard_filter_by_weight" hidden="hidden">Discard</button>
	</p>

	<table id="foods_table" border='1'>
		<tr>
			<th>Food</th>
			<th>Weight</th>
			<th>Price</th>
			<th>Avail.Qnt.</th>
			<th>Wish</th>
		</tr>
	</table>
	<a href="basket.html">Basket: (<span id="pnum">0</span>) item(s)</a>
</body>
</html>